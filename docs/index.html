<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
    <link rel="icon" type="image/png" href="favicon.ico" />

    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
      crossorigin="anonymous"
    ></script>

    <title>Lego Pi-ano</title>

    <meta property="og:title" content="Lego Pi-ano" />
    <meta
      property="og:description"
      content="Making the Lego Ideas Grand Piano fully playable using a Raspberry Pi, and using it as a game controller"
    />
    <meta
      property="og:url"
      content="https://debkbanerji.com/lego-pi-ano/assets/top_shot_preview.jpg"
    />

    <style>
      .d-block {
        padding-bottom: 30px;
      }

      .jumbotron {
        background: rgba(233, 236, 239, 0.1);
      }
    </style>

    <style class="dark-mode-stylesheet" disabled>
      html,
      body {
        background-color: black;
      }

      html,
      body,
      .table,
      .btn-outline-dark {
        color: #d3d3d3;
      }

      .btn {
        color: #ffffff;
      }

      .paintbrush-controls-button {
        background-color: #1c1c1c;
      }

      .btn-warning,
      .dropdown-item {
        color: #212529;
      }

      .card {
        background-color: rgb(33, 33, 33, 0.6);
      }

      .nav-tabs .nav-item.show .nav-link,
      .nav-tabs .nav-link.active {
        background-color: rgb(33, 33, 33, 0.6);
        border-color: rgb(50, 50, 50);
      }

      .nav-tabs {
        border-bottom: 0;
      }

      table {
        border-top: 1px solid rgb(50, 50, 50);
        border-left: 1px solid rgb(50, 50, 50);
      }

      td,
      th {
        border-bottom: 1px solid rgb(50, 50, 50);
        border-right: 1px solid rgb(50, 50, 50);
      }

      .table thead th {
        border-bottom: 1px solid rgb(50, 50, 50);
        border-top: 1px solid rgb(50, 50, 50);
      }
    </style>
  </head>

  <body>
    <div class="jumbotron">
      <h1 class="display-4">Playable Lego Piano</h1>
      <div class="row">
        <div class="col-md-8">
          <div style="margin-bottom: 5px;">
            <small>
              <span>Made with â™¥ by Deb</span> &bull;
              <a
                href="https://github.com/debkbanerji/lego-pi-ano"
                target="_blank"
                >Source Code</a
              >
            </small>
          </div>
          <p class="lead">
            Making the
            <a
              href="https://www.lego.com/en-us/product/grand-piano-21323"
              target="_blank"
              >Lego Ideas Grand Piano</a
            >
            fully playable using a Raspberry Pi, and
            <a
              href="https://www.youtube.com/watch?v=9nazm3_OXac"
              target="_blank"
              >using it as a game controller</a
            >.
          </p>
          <p>
            This is a modification of the original set so that each individual
            key is recognized. This makes it fully playable,
            <a
              href="https://www.youtube.com/watch?v=AyY2Fn1XPqc"
              target="_blank"
            >
              unlike the original</a
            >. The feel of the keys is unchanged and it supports full 25-key
            rollover with realistic sounds for each key, thanks to samples that
            my friend Mihir provided.
          </p>
          <p>
            <a
              href="https://github.com/debkbanerji/lego-pi-ano/tree/master/code"
              target="_blank"
              >Code</a
            >
            and
            <a
              href="https://github.com/debkbanerji/lego-pi-ano/tree/master/docs/assets"
              target="_blank"
              >diagrams</a
            >
            are included for anyone who wants to try modifying their own set.
            The modification was designed to be easily put together using cheap
            and easily available materials. If you run into issues, you can open
            a pull request or contact me through
            <a href="https://github.com/debkbanerji" target="_blank">GitHub</a>
            and I may be able to help (no guarantees).
          </p>
          <p>
            This is documentation for what is the second major version of this
            project. It was designed to be far more reliable and easy to
            reproduce than the first. I wouldn't have recommend for most people
            who own the piano to try the first version of the project, but with
            some time, I think anyone could reproduce this one quite well.
          </p>
        </div>
        <div class="col-md-4">
          <img class="img-fluid rounded" src="assets/top_shot_preview.jpg" />
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div class="row">
        <div class="col">
          <h2 style="padding-left: 12px;">Demos</h2>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <div style="padding: 12px;">
            <h4>Realistic Playability</h4>
            <div class="embed-responsive embed-responsive-16by9">
              <video controls>
                <source src="assets/demo_1.mp4" type="video/mp4" />
                Your browser does not support the video tag.
              </video>
            </div>
            <div style="padding-top: 10px;">
              <p>
                The cool part is that the software supports full 25 key
                rollover, so you can press multiple keys at the same time and
                the sound will still be realistic.
              </p>
              <p>
                Some keys are a little uneven since I was experimenting with
                switch types, but if you want to make your own, using the same
                switch creation procedure described further down this page
                should result in pretty even keys, as long as you're careful and
                test evenness as you go.
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div style="padding: 12px;">
            <h4>Flexible, Open Source UI</h4>
            <div style="margin-top: 10px; border: 1px solid black;">
              <img class="img-fluid" src="assets/ui_screenshot.jpg" />
            </div>
            <div style="padding-top: 10px;">
              <p>
                The code for the user interface is served by the Pi itself. It's
                a web UI that should be accessible over the local network using
                any device with a modern web browser. It's fully open source and
                not dependent on an app store (or even the internet!), so it
                doesn't carry the same risks pertaining to being discountinued,
                etc.
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div style="padding: 12px;">
            <h4>Gaming, for some reason</h4>
            <div class="embed-responsive embed-responsive-16by9">
              <video controls>
                <source src="assets/demo_2.mp4" type="video/mp4" />
                Your browser does not support the video tag.
              </video>
            </div>
            <div style="padding-top: 10px;">
              <p>
                You can also use the piano as a very strange game controller.
              </p>
              <p>
                I tested it with Batman: Arkham Knight, since the combat doesn't
                require many potentially uncomfortable button combos. I played a
                single player game because the piano didn't play well with
                anticheat in some multiplayer titles. The latency is not bad,
                and using UDP made it very easy to program. Theoretically, one
                could improve this by reprogramming the protocol in bluetooth,
                but if you're worried about latency, (I hope) you wouldn't use
                this in the first place.
              </p>
              <p>
                You can play wirelessly, but it was plugged in when I recorded
                the video since I had been playing for a bit and needed to
                charge the piano.
              </p>
              <p>
                Note that I haven't updated the code for the new switch design,
                but you can dig through the git history or get in touch with me
                if for some cursed reason you want to reproduce this.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <h2 style="padding-left: 12px;">Making Your Own</h2>
          <div style="margin-left: 12px;" class="p-3 mb-2 bg-info text-dark">
            <b>Disclaimer:</b> A little technical knowledge is required when
            putting this together - you'll need to know the basics of how a
            Raspberry Pi works, and how to run some simple code. A little
            Googling goes a long way here - these are things that should be
            doable to figure out for someone who was able to put together the
            base set. The procedure should be fairly reproducible with some
            tinkering. That being said, I make no guarantees about your success
            - the result has worked pretty well for me, but that's just a sample
            size of 1. I recommend reading through the information in its
            entirety before you start making your own. Please let me know if it
            worked!
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div style="padding: 12px;">
            <h4>What You'll Need</h4>
            <ul>
              <li>
                <b
                  ><a
                    href="https://www.lego.com/en-us/product/grand-piano-21323"
                    target="_blank"
                    >Lego Ideas Grand Piano, Set #21323</a
                  ></b
                >
              </li>
              <li>
                <b
                  ><a
                    href="https://www.raspberrypi.com/products/"
                    target="_blank"
                    >Raspberry Pi</a
                  ></b
                >
                - Get a standard sized Raspberry Pi, and make sure that the
                model you get has a wireless adapter (wifi). Other than that,
                the exact model shouldn't matter
              </li>
              <li>
                <b>Accompanying Raspbrry Pi stuff</b>
                - Make sure you have a keyboard, mouse, monitor, correct display
                cable, micro SD card, etc. so you can set up the Pi
              </li>
              <li>
                <b>Raspberry Pi jumper wires</b>
                - Make sure at least one side of each wire has a female
                connector so you can connect it to the Pi. We'll be removing the
                Dupont connector thingy at the other end. We'll need 26 wires,
                assuming none break.
              </li>
              <li>
                <b>Copper/Aluminium Tape</b>
                - <i>Important Note</i> - Make sure you buy tape where the
                adhesive side is also conductive
              </li>
              <li>
                <b>Scissors</b>
              </li>
              <li>
                <b>Tweezers</b>
                - <i>Optional</i> - You can make do without these, but they make
                things much easier, and also help remove tape if you're undoing
                mistakes
              </li>
              <li>
                <b>Continuity Tester</b>
                - <i>Optional</i> - Highly recommended so you can check that
                circuits are closing as expected while you're building the
                switches. Make sure you get one that can verify that can check
                circuits that aren't live. Mine was small and quite cheap.
              </li>
              <li>
                <b>Rubbing Alcohool/Alcohol Wipes</b>
                - <i>Optional</i> - You'll only needs these to remove tape
                residue if you mess something up
              </li>
              <li>
                <b>A Wifi Network</b>
                - <i>Optional</i> - May not really be required, but highly
                recommended, at least to set up. See the software section for a
                possible alternative, where the Pi hosts its own network.
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div style="padding: 12px;">
            <h4>The Software</h4>
            <p>
              You can find the
              <a
                href="https://github.com/debkbanerji/lego-pi-ano/tree/master/code"
                target="_blank"
                >code</a
              >
              here.
            </p>
            <p>
              <b>Setup Process (do this before starting hardware work)</b><br />

              The setup process has been greatly simplified since the first
              version. A lot of items here are not in as much detail as they
              could be, since tutorials for these steps online will be more
              comprehensive, and if something doesn't work right away, Google is
              your best bet anyway. For each step, you'll very likely have to
              just Google how to do it, but let me know if something looks off.
            </p>
            <ol>
              <li>
                Set up the Pi with an OS, if it doesn't have one already. I
                believe I used the default Raspbian.
              </li>
              <li>
                Download the
                <a
                  href="https://github.com/debkbanerji/lego-pi-ano"
                  target="_blank"
                  >Source Code</a
                >, either by cloning it using git or downloading and unzipping
                the repo somewhere. From now on, you'll be working in the `code`
                folder.
              </li>
              <li>
                Install the requirements from the requirements.txt file using
                pip.
              </li>
              <li>
                Run `piano-flask-server.py` using Python - I believe you'll need
                to be using Python 3, and the pip you used will have to match
              </li>
              <li>
                Connect your Raspberry pi to your wifi network, and set it up so
                that it will only boot when a wifi connection is available (I
                believe you can do this from the bios). Alternatively, you can
                look up how to get the Pi to host its own wifi network, but I
                haven't tested this.
              </li>
              <li>
                Find the local ip address of the Pi - using `ifconfig` should do
                the trick.
              </li>
              <li>
                Navigate to `(the pi's ip address):8080` (ex:
                `192.168.0.13:8080`) in a pc or phone browser that's on the same
                network, as the Pi, and make sure the UI shows up. If it
                doesn't, check that everything is connected to the network
                correctly.
              </li>
              <li>
                Set up the Pi so that the Python script runs at startup - for
                me, I believe modifying my bashrc did the trick.
              </li>
              <li>
                If everything went well, you shouldn't need to change software
                on the Pi anymore, so you can run it headless from now on.
              </li>
            </ol>

            <p>
              <b>Room for improvement</b><br />
              The software is far from perfect, and could be improved in many
              ways, most of which would offer much better responsiveness. The
              reason these haven't been done is because I haven't yet been able
              to justify the time commitment, but let me know if you'd be
              interested.
            </p>
            <ul>
              <li>
                Switching to web Bluetooth - Assuming the APIs are mature enough
              </li>
              <li>
                Switching to app based Bluetooth - Annoying due to being tied to
                app stores
              </li>
              <li>
                Switching to web sockets in browser - Getting this to work over
                local network would be really painful
              </li>
              <li>
                Adding support for the pressing of the pedal being recognized
                and incorporated into the sound
              </li>
              <li>
                Porting the old code over - these are non browser based
                solutions, which I don't recommend starting with because of the
                increased setup. That being said, if these were updated for the
                new switch designs, the responsiveness would be much better
                (these are UDP based) and it would allow for functionality such
                as gaming
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="row" style="padding: 12px; margin-bottom: 20px;">
        <div class="col-12">
          <h4>The Hardware</h4>
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_2.jpg"
          />
        </div>
        <div class="col-lg-6">
          <p>
            The key idea behind the design is using aluminum foil around the
            base and each key and connecting each key's foil to a GPIO output on
            the Raspebrry Pi to determine whether or not a key is pressed by
            checking whether or not the circuit was broken. This design results
            in keys which feel unchanged from those the original set, and
            hardware that can be built without needing to get a bunch of
            switches or printing a circuit board.
          </p>
          <p>
            We start by building just the keyboard portion of the Lego set (this
            starts at bag 11 of the instructions) - we'll revisit the rest of
            the set once this is working reliably. If your piano is already
            built, take it apart and lift out the keyboard and power functions
            assemblies so that you can work on the areas in the following
            pictures - it's annoying, but not as tricky as it looks, based on my
            experience. Once that's done, we'll wrap the entire base underneath
            the keys in foil - this will be our ground once we connect it to the
            Raspberry Pi's ground. We also add a male to female wire on 25
            separate GPIO pins starting from 2, and an additional wire for
            ground (consult a pin map of your model for this step). We haven't
            yet built the switches, but this is a good time to test out the
            software by manually closing the circuits and making sure the keys
            on the UI light up/produce sound.
          </p>
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_3.jpg"
          />
        </div>
        <div class="col-lg-6">
          <p>
            We need to extend the metal surface of each pin so that it can
            reliably contact the base containing the ground. In order to do
            this, we fold the aluminum foil a few times to make it sturdier and
            then cut it to the correct dimnsions (rough approximation in the
            picture). Then, we fold it in half so that it can wrap around each
            pin and secure it with electrical tape, tightly enough so that the
            foil makes contact with the metal pin. We do this 26 times to create
            one 'leaf' for each key, and one for ground. It's a good idea to
            check the connections again at this point.
          </p>
          <p>
            It's kind of weird, but works well for what we're trying to do. In
            an ideal situation, we'd secure the connections with solder, but I
            don't own a soldering iron, and this solution is significantly
            easier for most people.
          </p>
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_4.jpg"
          />
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_5.jpg"
          />
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_7.jpg"
          />
        </div>
        <div class="col-lg-6">
          <p>
            Once that's done, we tape each leaf to the correct key in sequence,
            as shown in the picture, making sure adjacent contacts don't touch
            each other. It's a good idea to use one layer of tape so that there
            isn't too much resistance between adjacent keys. I found that tape
            with a matte finish worked better for this part than the glossier
            electrical tape I had been using.
          </p>
          <p>
            It may be valuable to wrap each section of the base individually so
            that you can move the plates and make the keys easier to work with.
          </p>
          <p>Don't forget to connect the ground wire to the base</p>
          <p>
            If the keys don't return to rest easily due to the added friction,
            adding a rubber band to each hammer to pull it down over the the
            corresponding key helps a ton.
          </p>
          <p>
            Once again, it's a good idea to check the connections before
            proceeding.
          </p>
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_8.jpg"
          />
        </div>
        <div class="col-lg-6">
          <p>
            Now we get back to building the piano. Ignore the transparent tape
            on top of the keys in these pictures - these pictures were from the
            old switch design, but the steps from this point on are the same.
            We're going to build the rest of the Piano around the keys. Starting
            from the beginning, we omit the portion where we add the bracket for
            holding the power functions battery box included with the set (since
            we don't need it), but otherwise proceed as usual until step 76.
          </p>
          <p>
            The next pictures show the differences in the next few steps. We use
            the parts from these sets to seal in the wires between the keys and
            the Raspberry Pi, and try to orient it so that the ports are easily
            accessible from the right side panel, (and/or add a battery bank
            here if we want it to be entirely wireless).
          </p>
        </div>

        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_9.jpg"
          />
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_11.jpg"
          />
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_12.jpg"
          />
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_14.jpg"
          />
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_16.jpg"
          />
        </div>
        <div class="col-lg-6">
          <p>
            We then build the rest of the piano as usual. The only other tricky
            part is step 288, but isn't too bad if the keys are handled a little
            carefully.
          </p>
        </div>
        <div class="col-lg-6">
          <img
            class="img-fluid rounded"
            style="margin-bottom: 30px;"
            src="assets/diagram_17.jpg"
          />
        </div>
        <div class="col-lg-6">
          <p>
            Once we're done, the Raspberry Pi should be accessible from the side
            panel, so we can plug it in, swap out the speaker, add a power bank,
            etc.
          </p>
        </div>
      </div>
    </div>

    <canvas id="background-image-cache-canvas" hidden />
    <script>
      // add background generation code inline so it loads in before other logic
      function rgbToHex(r, g, b) {
        return (
          "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)
        );
      }

      function handleDarkModeChange() {
        const isDarkModeEnabled =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        Array.from(
          document.getElementsByClassName("dark-mode-stylesheet")
        ).forEach((stylesheet) => {
          stylesheet.disabled = !isDarkModeEnabled;
        });

        const canvas = document.getElementById("background-image-cache-canvas");
        const ctx = canvas.getContext("2d");

        const CIRCLE_RADIUS = 10;
        const WIDTH_COUNT = 40;
        const HEIGHT_COUNT = 20;
        const MIN_CIRCLE_BRIGHTNESS = 245;

        canvas.width = CIRCLE_RADIUS * WIDTH_COUNT;
        canvas.height = CIRCLE_RADIUS * HEIGHT_COUNT;

        for (let i = 0; i < HEIGHT_COUNT; i++) {
          for (let j = 0; j < WIDTH_COUNT; j++) {
            ctx.beginPath();
            ctx.arc(
              CIRCLE_RADIUS + 2 * i * CIRCLE_RADIUS,
              CIRCLE_RADIUS + 2 * j * CIRCLE_RADIUS,
              CIRCLE_RADIUS,
              0,
              2 * Math.PI
            );
            let brightness =
              MIN_CIRCLE_BRIGHTNESS +
              Math.floor(Math.random() * (255 - MIN_CIRCLE_BRIGHTNESS));
            if (isDarkModeEnabled) {
              brightness = 255 - brightness;
            }
            ctx.fillStyle = rgbToHex(brightness, brightness, brightness);
            ctx.fill();
          }
        }

        const dataURL = canvas.toDataURL("image/png", 1.0);

        document.body.style.backgroundImage = `url('${dataURL}')`;
      }

      handleDarkModeChange();
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", handleDarkModeChange);
    </script>
  </body>
</html>
